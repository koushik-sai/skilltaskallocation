<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    html {
      scroll-behavior: smooth;
    }

    .stars i {
      margin-right: 3px;
    }

    .sidebar {
      min-height: 100vh;
      border-right: 1px solid #dee2e6;
      background-color: #f8f9fa;
    }

    .sidebar .nav-link.active {
      font-weight: bold;
      color: #0d6efd !important;
    }

    .sidebar .nav-link {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .sidebar .nav-link:hover {
      background-color: #e9ecef;
      border-radius: 5px;
    }

    .progress {
      height: 1rem;
    }

    .progress-bar {
      font-size: 0.75rem;
      line-height: 1rem;
    }

    .dashboard-container {
      background-color: #f8f9fa;
    }

    /* Add some spacing for better visual separation */
    .section {
      scroll-margin-top: 20px;
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid d-flex justify-content-between align-items-center">
        <span class="navbar-text text-white me-3">
          Welcome, {{ currentUser?.name }}
        </span>
        <div class="d-flex align-items-center">
          <button (click)="handleLogout()" class="btn btn-outline-light btn-sm">
            <i class="bi bi-box-arrow-right"></i> Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar">
          <div class="position-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link fw-bold" (click)="scrollToSection('dashboard')">
                  <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" (click)="scrollToSection('tasks')">
                  <i class="bi bi-list-task me-2"></i>My Tasks
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" (click)="scrollToSection('available-tasks')">
                  <i class="bi bi-clipboard-check me-2"></i>Available Tasks
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" (click)="scrollToSection('skills')">
                  <i class="bi bi-gear me-2"></i>My Skills
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <!-- Dashboard Header -->
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom section" id="dashboard">
            <h1 class="h2">My Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <!-- Additional buttons can go here -->
            </div>
          </div>

          <!-- My Tasks Section -->
          <div class="card mb-4 section" id="tasks">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">My Tasks</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Title</th>
                      <th>Status</th>
                      <th>Deadline</th>
                      <th>Progress</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let task of myTasks">
                      <td>{{ task.title }}</td>
                      <td>
                        <span class="badge"
                              [ngClass]="{
                                'bg-success': task.status === 'COMPLETED',
                                'bg-warning text-dark': task.status === 'IN_PROGRESS',
                                'bg-info': task.status === 'PENDING',
                                'bg-danger': task.status === 'BLOCKED',
                                'bg-primary': task.status === 'ASSIGNED'
                              }">
                          {{ task.status }}
                        </span>
                      </td>
                      <td>{{ task.deadline | date: 'mediumDate' }}</td>
                      <td>
                        <div class="progress">
                          <div
                            class="progress-bar"
                            role="progressbar"
                            [style.width.%]="calculateProgress(task)"
                            [ngClass]="{
                              'bg-success': calculateProgress(task) >= 100,
                              'bg-warning': calculateProgress(task) >= 50 && calculateProgress(task) < 100,
                              'bg-danger': calculateProgress(task) < 50
                            }"
                          >
                            {{ calculateProgress(task) }}%
                          </div>
                        </div>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="openUpdateModal(task.taskId)">
                          <i class="bi bi-arrow-up-circle"></i> Update
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Update Modal -->
              <div class="modal fade show" tabindex="-1" [class.show]="showUpdateModal" [style.display]="showUpdateModal ? 'block' : 'none'" style="background-color: rgba(0, 0, 0, 0.6);">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content shadow-lg rounded-4 border-0">
                    <div class="modal-header text-white" style="background: linear-gradient(135deg, #007bff, #0056b3); border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                      <h5 class="modal-title fw-bold">üõ†Ô∏è Update Task Status</h5>
                      <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="showUpdateModal = false"></button>
                    </div>
                    <div class="modal-body bg-light px-4 py-3">
                      <div class="mb-3">
                        <label class="form-label fw-semibold">Status:</label>
                        <select [(ngModel)]="updateStatus" class="form-select rounded-3 border-primary shadow-sm">
                          <option value="IN_PROGRESS">üïí In Progress</option>
                          <option value="COMPLETED">‚úÖ Completed</option>
                          <option value="BLOCKED">‚õî Blocked</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label fw-semibold">Comment:</label>
                        <textarea [(ngModel)]="updateComment" rows="3" class="form-control rounded-3 shadow-sm border-secondary" placeholder="Add a meaningful comment..."></textarea>
                      </div>
                    </div>
                    <div class="modal-footer bg-white rounded-bottom-4 px-4 py-2">
                      <button class="btn btn-outline-secondary px-4" (click)="showUpdateModal = false">Cancel</button>
                      <button class="btn btn-primary px-4 fw-semibold" (click)="submitTaskUpdate()">Submit</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Available Tasks Section -->
          <div class="card mb-4 section" id="available-tasks">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">All Available Tasks</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Title</th>
                      <th>Description</th>
                      <th>Required Skills</th>
                      <th>Deadline</th>
                      <th>Priority</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let task of tasks">
                      <td>{{ task.title }}</td>
                      <td>{{ task.description }}</td>
                      <td>
                        <ng-container *ngFor="let skill of task.skills">
                          <span class="badge bg-secondary me-1">
                            {{ skill }} {{ skill.importanceLevel }}
                          </span>
                        </ng-container>
                      </td>
                      <td>{{ task.deadline | date: 'mediumDate' }}</td>
                      <td>
                        <span class="badge"
                              [ngClass]="{
                                'bg-danger': task.priority === 'HIGH',
                                'bg-warning text-dark': task.priority === 'MEDIUM',
                                'bg-success': task.priority === 'LOW'
                              }">
                          {{ task.priority }}
                        </span>
                      </td>
                      <td>{{ task.status }}</td>
                      <td>
                        <button class="btn btn-sm btn-success" (click)="openRequestModal(task.taskId)">
                          <i class="bi bi-send-fill"></i> Request Task
                        </button> 
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Task Request Modal -->
              <div *ngIf="showRequestModal" class="modal d-block" tabindex="-1" role="dialog" style="background-color: rgba(0, 0, 0, 0.6);">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">Request Task Assignment</h5>
                      <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="closeRequestModal()"></button>
                    </div>
                    <div class="modal-body bg-light">
                      <label for="requestMessage" class="form-label fw-semibold text-dark">Why are you a good fit for this task?</label>
                      <textarea 
                        id="requestMessage" 
                        class="form-control border border-primary" 
                        [(ngModel)]="requestMessage"
                        rows="4"
                        placeholder="Describe your relevant experience or skills..."
                      ></textarea>
                    </div>
                    <div class="modal-footer bg-white">
                      <button type="button" class="btn btn-success" (click)="submitTaskRequest()">
                        <i class="bi bi-check-circle-fill"></i> Submit
                      </button>
                      <button type="button" class="btn btn-outline-secondary" (click)="closeRequestModal()">
                        <i class="bi bi-x-circle"></i> Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Skills Section -->
          <div class="card mb-4 section" id="skills">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0 d-flex justify-content-between align-items-center">
                My Skills
                <button class="btn btn-light btn-sm" (click)="openAddModal()">
                  <i class="bi bi-plus-circle me-1"></i>Add Skill
                </button>
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div *ngIf="skills?.length === 0" class="col-12 text-center text-muted py-5">
                  <i class="bi bi-gear display-1 text-muted mb-3"></i>
                  <p>No skills found. Click "Add Skill" to get started.</p>
                </div>

                <div class="col-md-4 mb-3" *ngFor="let skill of skills">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column justify-content-between">
                      <div>
                        <h5 class="card-title">{{ skill.skillName }}</h5>
                        <p class="card-text">{{ skill.skillDescription || 'No description provided.' }}</p>
                      </div>
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <span class="text-muted">Proficiency:</span>
                          <div class="stars">
                            <ng-container *ngFor="let star of [1, 2, 3, 4, 5]">
                              <i class="bi bi-star-fill"
                                 [class.text-warning]="star <= getStars(skill.level)"
                                 [class.text-muted]="star > getStars(skill.level)">
                              </i>
                            </ng-container>
                          </div>
                        </div>
                        <div>
                          <button class="btn btn-sm btn-outline-secondary me-2" (click)="openEditModal(skill)" title="Edit">
                            <i class="bi bi-pencil-square"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" (click)="deleteSkill(skill.skillId!)" title="Delete">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ADD SKILL MODAL -->
          <div *ngIf="showAddModal" class="modal fade show d-block" tabindex="-1" role="dialog" (click)="closeAddModal()">
            <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Add Skill</h5>
                  <button type="button" class="btn-close" (click)="closeAddModal()"></button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label class="form-label">Skill Name</label>
                      <input type="text" class="form-control" [(ngModel)]="newSkill.skillName" name="addSkillName" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Description</label>
                      <textarea class="form-control" rows="2" [(ngModel)]="newSkill.skillDescription" name="addSkillDescription"></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Category</label>
                      <input type="text" class="form-control" [(ngModel)]="newSkill.category" name="addSkillCategory">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Proficiency Level</label>
                      <select class="form-select" [(ngModel)]="newSkill.level" name="addSkillLevel" required>
                        <option value="">Select Level</option>
                        <option value="BEGINNER">Beginner</option>
                        <option value="INTERMEDIATE">Intermediate</option>
                        <option value="ADVANCED">Advanced</option>
                      </select>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" (click)="closeAddModal()">Cancel</button>
                  <button class="btn btn-primary" (click)="addSkill()">Add</button>
                </div>
              </div>
            </div>
          </div>

          <!-- EDIT SKILL MODAL -->
          <div *ngIf="editSkillData" class="modal fade show d-block" tabindex="-1" role="dialog" (click)="closeEditModal()">
            <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Edit Skill</h5>
                  <button type="button" class="btn-close" (click)="closeEditModal()"></button>
                </div>
                <div class="modal-body">
                  <form>
                    <div class="mb-3">
                      <label class="form-label">Skill Name</label>
                      <input type="text" class="form-control" [(ngModel)]="editSkillData.skillName" name="editSkillName" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Description</label>
                      <textarea class="form-control" rows="2" [(ngModel)]="editSkillData.skillDescription" name="editSkillDescription"></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Category</label>
                      <input type="text" class="form-control" [(ngModel)]="editSkillData.category" name="editSkillCategory">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Proficiency Level</label>
                      <select class="form-select" [(ngModel)]="editSkillData.level" name="editSkillLevel" required>
                        <option value="">Select Level</option>
                        <option value="BEGINNER">Beginner</option>
                        <option value="INTERMEDIATE">Intermediate</option>
                        <option value="ADVANCED">Advanced</option>
                      </select>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
                  <button class="btn btn-primary" (click)="updateSkill()">Save</button>
                </div>
              </div>
            </div>
          </div>

        </main>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>